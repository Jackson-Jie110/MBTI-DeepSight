{% extends "base.html" %}
{% block title %}全息维度分析 · MBTI{% endblock %}

{% block content %}
  <div class="result-page">
    <div class="card result-hero">
      <div class="result-hero__header">
        <h1 class="result-hero__type">
          <span class="result-hero__type-label">全息维度分析</span>
        </h1>
        <p class="muted result-hero__subtitle">你的 RPG 角色属性面板</p>
        <p class="muted result-hero__desc">基于 MBTI 四维百分比，映射为 6 项能力维度（0-100）。</p>
      </div>
    </div>

    <div class="card">
      <h2 class="card-title">
        <span class="card-title__text">六维潜能雷达图</span>
      </h2>

      <div class="relative w-full h-[350px] md:h-[400px] flex justify-center items-center" style="height: 350px; position: relative;">
        <canvas id="radarChart" aria-label="六维潜能雷达图" role="img"></canvas>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <a class="btn" href="/">再测一次</a>
      </div>
    </div>
  </div>

  <script
    src="https://cdn.bootcdn.net/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"
    data-chartjs="1"
  ></script>
  <script>
    (function () {
      const canvas = document.getElementById("radarChart");
      if (!canvas) return;

      let radarData = {{ radar_data_json | safe }};
      if (!Array.isArray(radarData) || radarData.length !== 6) radarData = [50, 50, 50, 50, 50, 50];

      const chartCdn = "https://cdn.bootcdn.net/ajax/libs/Chart.js/4.4.1/chart.umd.min.js";

      function ensureChart(ready) {
        if (typeof Chart !== "undefined") return ready();

        const existing = document.querySelector("script[data-chartjs=\"1\"]");
        if (existing) {
          existing.addEventListener("load", () => ready(), { once: true });
          existing.addEventListener("error", () => {}, { once: true });
          return;
        }

        const s = document.createElement("script");
        s.src = chartCdn;
        s.async = true;
        s.dataset.chartjs = "1";
        s.onload = () => ready();
        document.body.appendChild(s);
      }

      function render() {
        if (typeof Chart === "undefined") return;

        const ctx = canvas.getContext("2d");
        if (!ctx) return;

        if (window.__mbtiRadarChart) {
          try {
            window.__mbtiRadarChart.destroy();
          } catch {}
        }

        window.__mbtiRadarChart = new Chart(ctx, {
          type: "radar",
          data: {
            labels: ["创造力", "执行力", "逻辑力", "共情力", "适应力", "社交力"],
            datasets: [
              {
                label: "能力潜能",
                data: radarData,
                backgroundColor: "rgba(99, 102, 241, 0.2)",
                borderColor: "rgba(99, 102, 241, 1)",
                pointBackgroundColor: "rgba(99, 102, 241, 1)",
                pointBorderColor: "#fff",
                pointHoverBackgroundColor: "#fff",
                pointHoverBorderColor: "rgba(99, 102, 241, 1)",
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              r: {
                suggestedMin: 0,
                suggestedMax: 100,
                angleLines: { color: "rgba(0, 0, 0, 0.05)" },
                grid: { color: "rgba(0, 0, 0, 0.05)" },
                pointLabels: {
                  font: { size: 12, family: "'Inter', sans-serif" },
                  color: "#4B5563",
                },
                ticks: { display: false, stepSize: 20 },
              },
            },
            plugins: {
              legend: { display: false },
            },
          },
        });
      }

      ensureChart(render);
    })();
  </script>
{% endblock %}
