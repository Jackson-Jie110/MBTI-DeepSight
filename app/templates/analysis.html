{% extends "base.html" %}
{% block title %}全息维度分析 · MBTI{% endblock %}

{% block content %}
  <div class="result-page">
    <div class="card result-hero">
      <div class="result-hero__header">
        <h1 class="result-hero__type">
          <span class="result-hero__type-label">全息维度分析</span>
        </h1>
        <p class="muted result-hero__subtitle">你的 RPG 角色属性面板</p>
        <p class="muted result-hero__desc">基于 MBTI 四维百分比，映射为 6 项能力维度（0-100）。</p>
      </div>
    </div>

    <section class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-8">
      <h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600 mb-6">
        六维潜能雷达图
      </h2>

      <div class="relative w-full h-[350px] md:h-[400px] flex justify-center items-center" style="height: 350px; position: relative;">
        <canvas id="radarChart" aria-label="六维潜能雷达图" role="img"></canvas>
      </div>
    </section>

    <div id="ai-analysis-container" class="min-h-[400px]">
      <div id="loading-spinner" class="py-20 flex flex-col items-center justify-center space-y-4">
        <svg
          width="40"
          height="40"
          style="width: 40px; height: 40px; min-width: 40px;"
          class="animate-spin text-indigo-500"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          ></path>
        </svg>
        <p class="text-gray-400 text-sm animate-pulse">正在解析你的性格代码...</p>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <a class="btn" href="/">再测一次</a>
      </div>
    </div>
  </div>

  <script src="{{ url_for('static', path='js/chart.umd.min.js') }}" data-chartjs="1"></script>
  <script>
    (function () {
      const canvas = document.getElementById("radarChart");
      if (!canvas) return;

      let radarData = {{ radar_data_json | safe }};
      if (!Array.isArray(radarData) || radarData.length !== 6) radarData = [50, 50, 50, 50, 50, 50];

      const chartSrc = "{{ url_for('static', path='js/chart.umd.min.js') }}";

      function ensureChart(ready) {
        if (typeof Chart !== "undefined") return ready();

        const existing = document.querySelector("script[data-chartjs=\"1\"]");
        if (existing) {
          existing.addEventListener("load", () => ready(), { once: true });
          existing.addEventListener("error", () => {}, { once: true });
          return;
        }

        const s = document.createElement("script");
        s.src = chartSrc;
        s.async = true;
        s.dataset.chartjs = "1";
        s.onload = () => ready();
        document.body.appendChild(s);
      }

      function render() {
        if (typeof Chart === "undefined") return;

        const ctx = canvas.getContext("2d");
        if (!ctx) return;

        if (window.__mbtiRadarChart) {
          try {
            window.__mbtiRadarChart.destroy();
          } catch {}
        }

        window.__mbtiRadarChart = new Chart(ctx, {
          type: "radar",
          data: {
            labels: ["创造力", "执行力", "逻辑力", "共情力", "适应力", "社交力"],
            datasets: [
              {
                label: "能力潜能",
                data: radarData,
                backgroundColor: "rgba(99, 102, 241, 0.2)",
                fill: true,
                borderColor: "#6366f1",
                borderWidth: 2,
                tension: 0,
                pointBackgroundColor: "#6366f1",
                pointBorderColor: "#fff",
                pointRadius: 4,
                pointHoverRadius: 6,
                pointHoverBackgroundColor: "#fff",
                pointHoverBorderColor: "#6366f1",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              r: {
                suggestedMin: 0,
                suggestedMax: 100,
                grid: {
                  circular: false,
                  color: "rgba(0, 0, 0, 0.05)",
                },
                angleLines: { color: "rgba(0, 0, 0, 0.05)" },
                pointLabels: {
                  font: { size: 12, family: "'Inter', sans-serif" },
                  color: "#4b5563",
                },
                ticks: { display: false, stepSize: 20 },
              },
            },
            plugins: {
              legend: { display: false },
            },
          },
        });
      }

      ensureChart(render);
    })();
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const container = document.getElementById("ai-analysis-container");
      const loading = document.getElementById("loading-spinner");

      const apiUrl = "{{ analysis_card_url }}";
      const basePayload = {{ analysis_card_payload_json | safe }};
      const params = Object.fromEntries(new URLSearchParams(window.location.search));
      const payload = Object.assign({}, basePayload, params);

      fetch(apiUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      })
        .then((response) => {
          if (!response.ok) throw new Error("Network response was not ok");
          return response.text();
        })
        .then((html) => {
          if (loading) loading.remove();
          container.innerHTML = html;
        })
        .catch((err) => {
          container.innerHTML = `
            <div class="p-6 bg-red-50 border border-red-100 rounded-xl text-center">
              <p class="text-red-600 font-bold mb-2">分析生成失败</p>
              <p class="text-red-400 text-sm">${String(err && err.message ? err.message : err)}</p>
              <button onclick="location.reload()" class="mt-4 text-xs bg-white border border-red-200 px-3 py-1 rounded hover:bg-red-50">重试</button>
            </div>
          `;
        });
    });
  </script>
{% endblock %}
