{% extends "base.html" %}
{% block title %}全息维度分析 · MBTI{% endblock %}

{% block content %}
  <div class="result-page">
    <div class="card result-hero">
      <div class="result-hero__header">
        <h1 class="result-hero__type">
          <span class="result-hero__type-label">全息维度分析</span>
        </h1>
        <p class="muted result-hero__subtitle">你的 RPG 角色属性面板</p>
        <p class="muted result-hero__desc">基于 MBTI 四维百分比，映射为 6 项能力维度（0-100）。</p>
      </div>
    </div>

    <div class="card">
      <h2 class="card-title">
        <span class="card-title__text">六维潜能雷达图</span>
      </h2>

      <div class="relative w-full h-[350px] md:h-[400px] flex justify-center items-center" style="height: 350px; position: relative;">
        <canvas id="radarChart" aria-label="六维潜能雷达图" role="img"></canvas>
      </div>
    </div>

    <div class="card min-h-[300px]">
      <h2 class="card-title">
        <span class="card-title__text">个人说明书 · 维度战争</span>
      </h2>

      <div id="analysis-loading-box" class="flex flex-col items-center justify-center py-12 space-y-4 text-indigo-400/60">
        <svg
          width="32"
          height="32"
          style="width: 32px; height: 32px; min-width: 32px;"
          class="animate-spin text-indigo-500"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          ></path>
        </svg>
        <p class="text-sm font-medium animate-pulse">DeepSeek 正在深度分析你的灵魂维度...</p>
      </div>

      <div
        id="analysis-result-box"
        class="ai-content prose prose-indigo prose-sm md:prose-base max-w-none text-gray-700 leading-relaxed hidden"
      ></div>
    </div>

    <div class="card">
      <div class="row">
        <a class="btn" href="/">再测一次</a>
      </div>
    </div>
  </div>

  <script src="{{ url_for('static', path='js/chart.umd.min.js') }}" data-chartjs="1"></script>
  <script src="{{ url_for('static', path='js/stream_loader.js') }}"></script>
  <script>
    (function () {
      const canvas = document.getElementById("radarChart");
      if (!canvas) return;

      let radarData = {{ radar_data_json | safe }};
      if (!Array.isArray(radarData) || radarData.length !== 6) radarData = [50, 50, 50, 50, 50, 50];

      const chartSrc = "{{ url_for('static', path='js/chart.umd.min.js') }}";

      function ensureChart(ready) {
        if (typeof Chart !== "undefined") return ready();

        const existing = document.querySelector("script[data-chartjs=\"1\"]");
        if (existing) {
          existing.addEventListener("load", () => ready(), { once: true });
          existing.addEventListener("error", () => {}, { once: true });
          return;
        }

        const s = document.createElement("script");
        s.src = chartSrc;
        s.async = true;
        s.dataset.chartjs = "1";
        s.onload = () => ready();
        document.body.appendChild(s);
      }

      function render() {
        if (typeof Chart === "undefined") return;

        const ctx = canvas.getContext("2d");
        if (!ctx) return;

        if (window.__mbtiRadarChart) {
          try {
            window.__mbtiRadarChart.destroy();
          } catch {}
        }

        window.__mbtiRadarChart = new Chart(ctx, {
          type: "radar",
          data: {
            labels: ["创造力", "执行力", "逻辑力", "共情力", "适应力", "社交力"],
            datasets: [
              {
                label: "能力潜能",
                data: radarData,
                backgroundColor: "rgba(99, 102, 241, 0.2)",
                fill: true,
                borderColor: "#6366f1",
                borderWidth: 2,
                tension: 0,
                pointBackgroundColor: "#6366f1",
                pointBorderColor: "#fff",
                pointRadius: 4,
                pointHoverRadius: 6,
                pointHoverBackgroundColor: "#fff",
                pointHoverBorderColor: "#6366f1",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              r: {
                suggestedMin: 0,
                suggestedMax: 100,
                grid: {
                  circular: false,
                  color: "rgba(0, 0, 0, 0.05)",
                },
                angleLines: { color: "rgba(0, 0, 0, 0.05)" },
                pointLabels: {
                  font: { size: 12, family: "'Inter', sans-serif" },
                  color: "#4b5563",
                },
                ticks: { display: false, stepSize: 20 },
              },
            },
            plugins: {
              legend: { display: false },
            },
          },
        });
      }

      ensureChart(render);
    })();
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const apiUrl = "{{ analysis_stream_url }}";
      const basePayload = {{ analysis_stream_payload_json | safe }};
      const params = Object.fromEntries(new URLSearchParams(window.location.search));
      const payload = Object.assign({}, basePayload, params);
      window.loadStream?.(apiUrl, "analysis-result-box", "analysis-loading-box", payload);
    });
  </script>
{% endblock %}
