{% extends "base.html" %}
{% block title %}全息维度分析 · MBTI{% endblock %}

{% block content %}
  <div class="result-page">
    <div class="card result-hero">
      <div class="result-hero__header">
        <h1 class="result-hero__type">
          <span class="result-hero__type-label">全息维度分析</span>
        </h1>
        <p class="muted result-hero__subtitle">你的 RPG 角色属性面板</p>
        <p class="muted result-hero__desc">基于 MBTI 四维百分比，映射为 6 项能力维度（0-100）。</p>
      </div>
    </div>

    <div class="card">
      <h2 class="card-title">
        <span class="card-title__text">六维潜能雷达图</span>
      </h2>

      <div class="relative w-full h-[350px] md:h-[400px] flex justify-center items-center" style="height: 350px; position: relative;">
        <canvas id="radarChart" aria-label="六维潜能雷达图" role="img"></canvas>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <a class="btn" href="/">再测一次</a>
      </div>
    </div>
  </div>

  <script src="{{ url_for('static', path='js/chart.umd.min.js') }}" data-chartjs="1"></script>
  <script>
    (function () {
      const canvas = document.getElementById("radarChart");
      if (!canvas) return;

      let radarData = {{ radar_data_json | safe }};
      if (!Array.isArray(radarData) || radarData.length !== 6) radarData = [50, 50, 50, 50, 50, 50];

      const chartSrc = "{{ url_for('static', path='js/chart.umd.min.js') }}";

      function ensureChart(ready) {
        if (typeof Chart !== "undefined") return ready();

        const existing = document.querySelector("script[data-chartjs=\"1\"]");
        if (existing) {
          existing.addEventListener("load", () => ready(), { once: true });
          existing.addEventListener("error", () => {}, { once: true });
          return;
        }

        const s = document.createElement("script");
        s.src = chartSrc;
        s.async = true;
        s.dataset.chartjs = "1";
        s.onload = () => ready();
        document.body.appendChild(s);
      }

      function render() {
        if (typeof Chart === "undefined") return;

        const ctx = canvas.getContext("2d");
        if (!ctx) return;

        if (window.__mbtiRadarChart) {
          try {
            window.__mbtiRadarChart.destroy();
          } catch {}
        }

        // 1) Create crystal-like gradient (Indigo -> Pink)
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, "rgba(99, 102, 241, 0.7)"); // Indigo-500 (Top)
        gradient.addColorStop(1, "rgba(236, 72, 153, 0.4)"); // Pink-500 (Bottom)

        window.__mbtiRadarChart = new Chart(ctx, {
          type: "radar",
          data: {
            labels: ["创造力", "执行力", "逻辑力", "共情力", "适应力", "社交力"],
            datasets: [
              {
                label: "能力潜能",
                data: radarData,
                backgroundColor: gradient,
                fill: true,
                borderColor: "rgba(255, 255, 255, 0.9)",
                borderWidth: 3,
                tension: 0,
                pointBackgroundColor: "#fff",
                pointBorderColor: "rgba(99, 102, 241, 1)",
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointHoverBackgroundColor: "#fff",
                pointHoverBorderColor: "rgba(236, 72, 153, 1)",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              r: {
                suggestedMin: 0,
                suggestedMax: 100,
                grid: {
                  circular: false,
                  color: "rgba(0, 0, 0, 0.05)",
                  lineWidth: 1,
                },
                angleLines: { color: "rgba(0, 0, 0, 0.05)" },
                pointLabels: {
                  font: { size: 13, family: "'Inter', sans-serif", weight: "600" },
                  color: "#6366f1",
                },
                ticks: { display: false, stepSize: 20 },
              },
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: "rgba(255, 255, 255, 0.9)",
                titleColor: "#1f2937",
                bodyColor: "#6366f1",
                borderColor: "#e5e7eb",
                borderWidth: 1,
                displayColors: false,
                padding: 10,
                callbacks: {
                  label: (context) => `${context.parsed.r} 分`,
                },
              },
            },
          },
        });
      }

      ensureChart(render);
    })();
  </script>
{% endblock %}
