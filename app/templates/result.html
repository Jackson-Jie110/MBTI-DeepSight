{% extends "base.html" %}
{% block title %}结果 · MBTI{% endblock %}
{% block content %}
  <div class="result-page">
    <style>
      /* 强制 AI 渲染区域标题左对齐，兜底防止缩进/边距异常 */
      .ai-content :is(h1, h2, h3, h4, h5, h6) {
        margin-left: 0 !important;
        padding-left: 0 !important;
        text-indent: 0 !important;
      }
    </style>

    <div class="card result-hero">
      <div class="result-hero__header">
        <h1 class="result-hero__type">
          <span class="result-hero__type-label">你的类型：</span><span
            class="result-hero__typecode"
            style="background-image: linear-gradient(90deg, var(--cta), var(--primary)); -webkit-background-clip: text; background-clip: text; color: transparent; -webkit-text-fill-color: transparent;"
            >{{ type_code }}</span
          >
        </h1>
        <p class="muted result-hero__subtitle">{{ report.title }}</p>
        <p class="muted result-hero__desc">仅展示类型、四维百分比与完整报告（不展示每题明细）。</p>
      </div>

      <div class="field result-hero__share">
        <label>分享链接</label>
        <div class="row compact">
          <input class="input grow" id="share-url" value="{{ share_url }}" readonly />
          <button class="btn" type="button" data-copy-target="#share-url">复制</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2 class="card-title"><span class="card-title__text" style="background-image: linear-gradient(90deg, var(--primary), var(--cta)); -webkit-background-clip: text; background-clip: text; color: transparent; -webkit-text-fill-color: transparent;">四维百分比</span></h2>
      <div class="bars">
        {% for d in dimensions %}
          <div class="bar">
            <div class="bar-head">
              <span>{{ d.dimension }}：{{ d.first_pole }} {{ d.first_percent }}% / {{ d.second_pole }} {{ d.second_percent }}%</span>
              <span class="muted">差距 {{ d.gap_percent }}%</span>
            </div>
            <div class="bar-track">
              <div class="bar-fill" style="width: {{ d.first_percent }}%"></div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    {% if report.insights %}
      <div class="card contrast">
        <h2 class="card-title"><span class="card-title__text" style="background-image: linear-gradient(90deg, var(--primary), var(--cta)); -webkit-background-clip: text; background-clip: text; color: transparent; -webkit-text-fill-color: transparent;">动态洞察</span></h2>
        <ul class="result-list">
          {% for i in report.insights %}
            <li>{{ i }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <div id="ai-container" class="card ai-card">
      <div class="ai-card__head">
        <div class="mb-4 flex flex-col gap-y-2">
          <h2 class="ai-card__title card-title">
            <span class="ai-card__title-gradient card-title__text" style="background-image: linear-gradient(90deg, var(--cta), var(--primary)); -webkit-background-clip: text; background-clip: text; color: transparent; -webkit-text-fill-color: transparent;">AI 深度性格侧写</span>
          </h2>
          <span class="w-fit text-[10px] font-mono font-normal px-2 py-0.5 rounded border border-indigo-200 bg-indigo-50 text-indigo-500/80 align-middle tracking-tight">
            Powered by DeepSeek-V3.2
          </span>
        </div>
        <p class="muted ai-card__subtitle">基于你的类型，给出更偏“心灵侧写”的文字解读。</p>
      </div>

      <div class="ai-loading">
        <svg width="24" height="24" style="width: 24px; height: 24px; min-width: 24px;" class="ai-loading__spinner" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="ai-loading__text">正在连接 AI 咨询师...</span>
      </div>

      <div class="ai-content is-hidden prose-headings:pl-0 prose-headings:ml-0 prose-headings:indent-0"></div>

      <script>
        (function () {
          const container = document.currentScript.closest("#ai-container");
          const loadingEl = container.querySelector(".ai-loading");
          const contentEl = container.querySelector(".ai-content");
          const streamUrl = "/result/ai_stream/{{ share_token }}";

          const es = new EventSource(streamUrl);
          let fullText = "";

          es.onmessage = function (event) {
            if (loadingEl && loadingEl.style.display !== "none") {
              loadingEl.style.display = "none";
              contentEl.classList.remove("is-hidden");
            }

            try {
              if (event.data.startsWith("retry:")) return;

              let chunk = JSON.parse(event.data);
              chunk = chunk.replace(/TAGS_SHORT_READ_WARNING\s+\w+/g, "");
              fullText += chunk;

              if (typeof marked !== "undefined") {
                let cleanText = fullText
                  // 1. 去除行首的所有空白字符（包括空格、Tab），强制 ### 顶格
                  .replace(/^\s+(#{1,6})/gm, "$1")
                  // 2. 规范化标题后的空格（含全角空格/不换行空格）
                  .replace(/(#{1,6})[\s\u3000\u00A0]+/gm, "$1 ")
                  // 3. 修复加粗语法紧贴标题时的潜在空格
                  .replace(/(#{1,6} \*\*)[\s\u3000\u00A0]+/gm, "$1");

                const html = marked.parse(cleanText);
                contentEl.innerHTML = html;
              } else {
                contentEl.innerText = fullText;
              }
            } catch (e) {
              // ignore
            }
          };

          es.onerror = function () {
            es.close();
          };
        })();
      </script>
    </div>

    <div class="card result-full">
      <div class="result-full__head">
        <h2 class="card-title"><span class="card-title__text" style="background-image: linear-gradient(90deg, var(--primary), var(--cta)); -webkit-background-clip: text; background-clip: text; color: transparent; -webkit-text-fill-color: transparent;">完整分析</span></h2>
        <p class="muted result-full__meta">{{ report.type_code }}（{{ report.title }}）</p>
        <p class="muted result-full__summary">{{ report.summary }}</p>
      </div>

      <div class="result-grid">
        {% if report.boundary_notes %}
          <section class="result-subcard result-subcard--note">
            <h3>边界提示</h3>
            <ul class="result-list">
              {% for n in report.boundary_notes %}
                <li>{{ n }}</li>
              {% endfor %}
            </ul>
          </section>
        {% endif %}

        <section class="result-subcard">
          <h3>优势</h3>
          <ul class="result-list">
            {% for s in report.strengths %}
              <li>{{ s }}</li>
            {% endfor %}
          </ul>
        </section>

        <section class="result-subcard">
          <h3>盲点</h3>
          <ul class="result-list">
            {% for s in report.blind_spots %}
              <li>{{ s }}</li>
            {% endfor %}
          </ul>
        </section>

        <section class="result-subcard">
          <h3>建议</h3>
          <ul class="result-list">
            {% for s in report.advice %}
              <li>{{ s }}</li>
            {% endfor %}
          </ul>
        </section>

        <section class="result-subcard">
          <h3>适合方向</h3>
          <ul class="result-list">
            {% for s in report.suitable %}
              <li>{{ s }}</li>
            {% endfor %}
          </ul>
        </section>
      </div>

      <p class="muted">{{ report.disclaimer }}</p>
      <div class="row">
        <form action="/analysis" method="post" hx-boost="false">
          <input type="hidden" name="type" value="{{ type_code }}" />
          <input type="hidden" name="dimensions" value='{{ dimensions_json | e }}' />
          <button class="btn" type="submit">解锁更多分析</button>
        </form>
      </div>
    </div>
  </div>
{% endblock %}
