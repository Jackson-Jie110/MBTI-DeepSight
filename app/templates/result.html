{% extends "base.html" %}
{% block title %}结果 · MBTI{% endblock %}
{% block content %}
  <div class="result-page">
    <style>
      /* 强制 AI 渲染区域标题左对齐，兜底防止缩进/边距异常 */
      .ai-content :is(h1, h2, h3, h4, h5, h6) {
        margin-left: 0 !important;
        padding-left: 0 !important;
        text-indent: 0 !important;
      }
    </style>

    <div class="card result-hero">
      <div class="result-hero__header">
        <h1 class="result-hero__type">
          <span class="result-hero__type-label">你的类型：</span><span
            class="result-hero__typecode"
            style="background-image: linear-gradient(90deg, var(--cta), var(--primary)); -webkit-background-clip: text; background-clip: text; color: transparent; -webkit-text-fill-color: transparent;"
            >{{ type_code }}</span
          >
        </h1>
        <p class="muted result-hero__subtitle">{{ report.title }}</p>
        <p class="muted result-hero__desc">仅展示类型、四维百分比与完整报告（不展示每题明细）。</p>
      </div>

      <div class="field result-hero__share">
        <label>分享链接</label>
        <div class="row compact">
          <input class="input grow" id="share-url" value="{{ share_url }}" readonly />
          <button class="btn" type="button" data-copy-target="#share-url">复制</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2 class="card-title"><span class="card-title__text" style="background-image: linear-gradient(90deg, var(--primary), var(--cta)); -webkit-background-clip: text; background-clip: text; color: transparent; -webkit-text-fill-color: transparent;">四维百分比</span></h2>
      <div class="bars">
        {% for d in dimensions %}
          <div class="bar">
            <div class="bar-head">
              <span>{{ d.dimension }}：{{ d.first_pole }} {{ d.first_percent }}% / {{ d.second_pole }} {{ d.second_percent }}%</span>
              <span class="muted">差距 {{ d.gap_percent }}%</span>
            </div>
            <div class="bar-track">
              <div class="bar-fill" style="width: {{ d.first_percent }}%"></div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    {% if report.insights %}
      <div class="card contrast">
        <h2 class="card-title"><span class="card-title__text" style="background-image: linear-gradient(90deg, var(--primary), var(--cta)); -webkit-background-clip: text; background-clip: text; color: transparent; -webkit-text-fill-color: transparent;">动态洞察</span></h2>
        <ul class="result-list">
          {% for i in report.insights %}
            <li>{{ i }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <div id="ai-container" class="card ai-card">
      <div class="ai-card__head">
        <div class="mb-4 flex flex-col gap-y-2">
          <h2 class="ai-card__title card-title">
            <span class="ai-card__title-gradient card-title__text" style="background-image: linear-gradient(90deg, var(--cta), var(--primary)); -webkit-background-clip: text; background-clip: text; color: transparent; -webkit-text-fill-color: transparent;">AI 深度性格侧写</span>
          </h2>
          <span class="w-fit text-[10px] font-mono font-normal px-2 py-0.5 rounded border border-indigo-200 bg-indigo-50 text-indigo-500/80 align-middle tracking-tight">
            Powered by DeepSeek-V3.2
          </span>
        </div>
        <p class="muted ai-card__subtitle">基于你的类型，给出更偏“心灵侧写”的文字解读。</p>
      </div>

      <div id="ai-loading-box" class="flex flex-col items-center justify-center py-10 space-y-4">
        <svg
          width="32"
          height="32"
          style="width: 32px; height: 32px; min-width: 32px;"
          class="animate-spin h-8 w-8 text-indigo-500 ai-loading__spinner"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          ></path>
        </svg>
        <p class="text-sm font-medium text-indigo-400/80 animate-pulse">DeepSeek 正在连接你的思维宇宙...</p>
      </div>

      <div
        id="ai-result-box"
        class="ai-content prose prose-indigo prose-sm md:prose-base max-w-none text-gray-700 leading-relaxed hidden"
      ></div>
    </div>

    <div class="card result-full">
      <div class="result-full__head">
        <h2 class="card-title"><span class="card-title__text" style="background-image: linear-gradient(90deg, var(--primary), var(--cta)); -webkit-background-clip: text; background-clip: text; color: transparent; -webkit-text-fill-color: transparent;">完整分析</span></h2>
        <p class="muted result-full__meta">{{ report.type_code }}（{{ report.title }}）</p>
        <p class="muted result-full__summary">{{ report.summary }}</p>
      </div>

      <div class="result-grid">
        {% if report.boundary_notes %}
          <section class="result-subcard result-subcard--note">
            <h3>边界提示</h3>
            <ul class="result-list">
              {% for n in report.boundary_notes %}
                <li>{{ n }}</li>
              {% endfor %}
            </ul>
          </section>
        {% endif %}

        <section class="result-subcard">
          <h3>优势</h3>
          <ul class="result-list">
            {% for s in report.strengths %}
              <li>{{ s }}</li>
            {% endfor %}
          </ul>
        </section>

        <section class="result-subcard">
          <h3>盲点</h3>
          <ul class="result-list">
            {% for s in report.blind_spots %}
              <li>{{ s }}</li>
            {% endfor %}
          </ul>
        </section>

        <section class="result-subcard">
          <h3>建议</h3>
          <ul class="result-list">
            {% for s in report.advice %}
              <li>{{ s }}</li>
            {% endfor %}
          </ul>
        </section>

        <section class="result-subcard">
          <h3>适合方向</h3>
          <ul class="result-list">
            {% for s in report.suitable %}
              <li>{{ s }}</li>
            {% endfor %}
          </ul>
        </section>
      </div>

      <p class="muted">{{ report.disclaimer }}</p>
      <div class="row">
        <form action="/analysis" method="post" hx-boost="false">
          <input type="hidden" name="type" value="{{ type_code }}" />
          <input type="hidden" name="dimensions" value='{{ dimensions_json | e }}' />
          <button class="btn" type="submit">解锁更多分析</button>
        </form>
      </div>
    </div>
  </div>

  <script src="{{ url_for('static', path='js/stream_loader.js') }}"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const apiUrl = "{{ result_ai_stream_url }}";
      const params = Object.fromEntries(new URLSearchParams(window.location.search));
      window.loadStream?.(apiUrl, "ai-result-box", "ai-loading-box", params);
    });
  </script>
{% endblock %}
