{% extends "base.html" %}
{% block title %}结果 · MBTI{% endblock %}
{% block content %}
  <div class="card">
    <h1>你的类型：{{ type_code }}</h1>
    <p class="muted">仅展示类型、四维百分比与完整报告（不展示每题明细）。</p>
    <div class="field">
      <label>分享链接</label>
      <div class="row compact">
        <input class="input grow" id="share-url" value="{{ share_url }}" readonly />
        <button class="btn" type="button" data-copy-target="#share-url">复制</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>四维百分比</h2>
    <div class="bars">
      {% for d in dimensions %}
        <div class="bar">
          <div class="bar-head">
            <span>{{ d.dimension }}：{{ d.first_pole }} {{ d.first_percent }}% / {{ d.second_pole }} {{ d.second_percent }}%</span>
            <span class="muted">差距 {{ d.gap_percent }}%</span>
          </div>
          <div class="bar-track">
            <div class="bar-fill" style="width: {{ d.first_percent }}%"></div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  {% if report.insights %}
    <div class="card contrast">
      <h2>动态洞察（Layer 2）</h2>
      <ul>
        {% for i in report.insights %}
          <li>{{ i }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <div id="ai-container" 
       class="prose prose-slate max-w-none text-gray-700 leading-relaxed bg-white p-6 rounded-lg shadow-sm border border-gray-100"
       hx-ext="sse" 
       sse-connect="/result/ai_stream/{{ share_token }}"
       hx-on:sse-message="
          try {
              const newContent = JSON.parse(event.detail.data);
              if (!this.fullText) this.fullText = '';
              this.fullText += newContent;
              
              if (typeof marked === 'undefined') {
                  this.innerHTML = this.fullText.replace(/\\n/g, '<br/>');
              } else {
                  this.innerHTML = marked.parse(this.fullText);
              }
              
          } catch (e) {
              console.log('Stream Update Error:', e);
          }
       ">
    
    <div class="flex items-center space-x-2 text-gray-400">
        <svg style="width: 20px; height: 20px;" class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="text-sm">正在连接 AI 咨询师...</span>
    </div>

  </div>

  <div class="card">
    <h2>完整分析：{{ report.type_code }}（{{ report.title }}）</h2>
    <p>{{ report.summary }}</p>

    {% if report.boundary_notes %}
      <div class="alert">
        <strong>边界提示：</strong>
        <ul>
          {% for n in report.boundary_notes %}
            <li>{{ n }}</li>
          {% endfor %}
        </ul>
      </div>
      <div class="divider"></div>
    {% endif %}

    <h3>优势</h3>
    <ul>
      {% for s in report.strengths %}
        <li>{{ s }}</li>
      {% endfor %}
    </ul>

    <h3>盲点</h3>
    <ul>
      {% for s in report.blind_spots %}
        <li>{{ s }}</li>
      {% endfor %}
    </ul>

    <h3>建议</h3>
    <ul>
      {% for s in report.advice %}
        <li>{{ s }}</li>
      {% endfor %}
    </ul>

    <h3>适合方向</h3>
    <ul>
      {% for s in report.suitable %}
        <li>{{ s }}</li>
      {% endfor %}
    </ul>

    <p class="muted">{{ report.disclaimer }}</p>
    <div class="row">
      <a class="btn" href="/">再测一次</a>
    </div>
  </div>
{% endblock %}
