{% extends "base.html" %}
{% block title %}答题 · MBTI{% endblock %}
{% block content %}
  <style>
    /* Fallback for opacity transitions even if Tailwind JIT is unavailable */
    #question-container {
      transition: opacity 200ms ease-in-out;
      will-change: opacity;
    }
    #question-container.opacity-0 {
      opacity: 0;
    }

    /* Click feedback highlight (keeps consistent with site palette) */
    .scale .quiz-option.is-selected {
      border-color: rgba(139, 92, 246, 0.55);
      background: linear-gradient(180deg, rgba(139, 92, 246, 0.22), rgba(236, 72, 153, 0.12));
      box-shadow: var(--shadow-sm);
      color: var(--text-strong);
    }
    .scale .quiz-option:disabled {
      cursor: not-allowed;
      opacity: 0.72;
    }
  </style>

  <div class="card" id="quiz-root">
    <div class="progress">
      <div class="badge" id="quiz-pos">第 1 / 1 题</div>
      <div class="badge" id="quiz-mode">5 级量表</div>
    </div>
    <div class="progress-track" aria-hidden="true">
      <div class="progress-fill" id="quiz-progress" style="width: 0%"></div>
    </div>

    <div id="question-container" class="transition-opacity duration-200 ease-in-out">
      <h2 id="quiz-question" style="min-height: 3.2em"></h2>
      <div class="scale" id="quiz-scale" role="group" aria-label="选择你的同意程度"></div>
    </div>

    <div class="divider"></div>
    <div class="row">
      <button class="btn" type="button" id="btn-prev">上一题</button>
      <button class="btn primary" type="button" id="btn-next">下一题</button>
      <button class="btn danger" type="button" id="btn-exit">保存并退出</button>
    </div>
    <p class="muted" id="quiz-hint" style="display:none"></p>
  </div>

  <script>
    const ALL_QUESTIONS = {{ questions_json | safe }};
    const EXISTING_ANSWERS = {{ answers_json | safe }};
    const CSRF_TOKEN = "{{ csrf_token }}";
    let currentIndex = {{ initial_index | int }};

    const LABELS = {
      1: "非常不同意",
      2: "不同意",
      3: "一般",
      4: "同意",
      5: "非常同意",
    };

    const answersById = Object.assign({}, EXISTING_ANSWERS);

    const root = document.getElementById("quiz-root");
    const elPos = document.getElementById("quiz-pos");
    const elProgress = document.getElementById("quiz-progress");
    const elQuestion = document.getElementById("quiz-question");
    const elScale = document.getElementById("quiz-scale");
    const elHint = document.getElementById("quiz-hint");

    const btnPrev = document.getElementById("btn-prev");
    const btnNext = document.getElementById("btn-next");
    const btnExit = document.getElementById("btn-exit");
    const questionContainer = document.getElementById("question-container");

    let isAnimating = false;

    function setHint(text) {
      if (!text) {
        elHint.style.display = "none";
        elHint.textContent = "";
        return;
      }
      elHint.style.display = "";
      elHint.textContent = text;
    }

    function render() {
      const total = ALL_QUESTIONS.length;
      if (total === 0) {
        elQuestion.textContent = "题库为空，请联系管理员。";
        btnPrev.disabled = true;
        btnNext.disabled = true;
        btnExit.disabled = false;
        return;
      }

      currentIndex = Math.max(0, Math.min(total - 1, currentIndex));
      const q = ALL_QUESTIONS[currentIndex];

      const posText = `第 ${currentIndex + 1} / ${total} 题${q.is_extra ? " · 加测" : ""}`;
      elPos.textContent = posText;

      const pct = Math.floor(((currentIndex + 1) / total) * 100);
      elProgress.style.width = `${pct}%`;

      elQuestion.textContent = q.text || "";
      setHint("");

      btnPrev.disabled = currentIndex <= 0;

      // Rebuild scale
      elScale.innerHTML = "";
      const picked = answersById[String(q.id)] ?? answersById[q.id];

      for (const v of [1, 2, 3, 4, 5]) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "option quiz-option";
        btn.setAttribute("data-score", String(v));
        btn.textContent = LABELS[v];
        if (Number(picked) === v) {
          btn.classList.add("is-selected");
        }
        btn.addEventListener("click", () => selectOption(v, btn));
        elScale.appendChild(btn);
      }
    }

    function setControlsDisabled(disabled) {
      for (const el of elScale.querySelectorAll("button.quiz-option")) {
        el.disabled = !!disabled;
      }
      btnPrev.disabled = disabled || currentIndex <= 0;
      btnNext.disabled = !!disabled;
      btnExit.disabled = !!disabled;
    }

    function requirePicked() {
      const q = ALL_QUESTIONS[currentIndex];
      const picked = answersById[String(q.id)] ?? answersById[q.id];
      if (!picked) {
        setHint("请选择一个选项后再继续。");
        return false;
      }
      return true;
    }

    function fadeToIndex(nextIndex) {
      if (isAnimating) return;
      isAnimating = true;
      setControlsDisabled(true);

      // start fade out
      questionContainer.classList.add("opacity-0");

      setTimeout(() => {
        currentIndex = nextIndex;
        render();

        // fade in on next frame for smoother transition
        requestAnimationFrame(() => {
          questionContainer.classList.remove("opacity-0");
        });

        isAnimating = false;
        setControlsDisabled(false);
      }, 200);
    }

    function selectOption(score, btn) {
      if (isAnimating) return;
      isAnimating = true;

      const q = ALL_QUESTIONS[currentIndex];
      answersById[q.id] = score;

      // 1) immediate visual feedback
      for (const el of elScale.querySelectorAll("button.quiz-option")) {
        el.classList.remove("is-selected");
      }
      btn.classList.add("is-selected");

      // 2) prevent double click during animation
      setControlsDisabled(true);

      // 3) wait a bit to let user see the highlight
      setTimeout(() => {
        // 4) fade out
        questionContainer.classList.add("opacity-0");

        // 5) after fade-out, switch content then fade-in
        setTimeout(() => {
          if (currentIndex < ALL_QUESTIONS.length - 1) {
            currentIndex += 1;
            render();
            requestAnimationFrame(() => {
              questionContainer.classList.remove("opacity-0");
            });
            isAnimating = false;
            setControlsDisabled(false);
          } else {
            // last question: submit
            submitFinish();
          }
        }, 200);
      }, 250);
    }

    async function saveAll(intent) {
      const answers = Object.entries(answersById).map(([qid, value]) => ({
        question_id: Number(qid),
        value: Number(value),
      }));

      const res = await fetch("/test/answers", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          csrf_token: CSRF_TOKEN,
          intent,
          answers,
        }),
      });

      if (!res.ok) {
        const t = await res.text();
        throw new Error(`保存失败: ${res.status} ${t}`);
      }

      return await res.json();
    }

    async function submitFinish() {
      btnPrev.disabled = true;
      btnNext.disabled = true;
      btnExit.disabled = true;
      setHint("正在提交作答并生成结果...");
      try {
        const data = await saveAll("finish");
        const redirect = data.redirect || "/finish";
        window.location.href = redirect;
      } catch (e) {
        setHint(String(e));
        btnExit.disabled = false;
      }
    }

    btnPrev.addEventListener("click", () => {
      if (currentIndex > 0) fadeToIndex(currentIndex - 1);
    });

    btnNext.addEventListener("click", () => {
      if (!requirePicked()) return;
      if (currentIndex < ALL_QUESTIONS.length - 1) return fadeToIndex(currentIndex + 1);
      submitFinish();
    });

    btnExit.addEventListener("click", async () => {
      btnPrev.disabled = true;
      btnNext.disabled = true;
      btnExit.disabled = true;
      setHint("正在保存进度...");
      try {
        const data = await saveAll("exit");
        window.location.href = data.redirect || "/";
      } catch (e) {
        setHint(String(e));
        btnExit.disabled = false;
      }
    });

    render();
  </script>
{% endblock %}
